@using Admin.Data.Events
@using Admin.Data.Helpers
@using MudBlazor.Extensions

@inject AppointmentViewService EventService

<div class="scheduler-container" style="--scheduler-table-cell-height: @(AppointmentLayoutConsts.CellHeight)px">
    <SchedulerHeader Date="@Date" LayoutType="@CalendarLayoutType" OnCalendarStateChange="OnCalendarStateChange" />
    @if (CalendarLayoutType == CalendarLayoutType.Month)
    {
        <SchedulerMonth StartDate="@(DateRange.Item1)" EndDate="@(DateRange.Item2)" Events="@Events" OnCalendarStateChange="OnCalendarStateChange" />
    }
    else
    {
        <SchedulerDays StartDate="@(DateRange.Item1)" EndDate="@(DateRange.Item2)" Events="@Events" OnCalendarStateChange="OnCalendarStateChange" />
    }
</div>

<div>
    <button @onclick="TestErrors">Click Me For Errors!</button>
</div>

@code {

    private CalendarLayoutType CalendarLayoutType = CalendarLayoutType.Week;

    /// <summary>
    /// The selected date.
    /// </summary>
    private DateTime Date =
        DateTime.Now.StartOfWeek(
            System.Threading.Thread.CurrentThread.CurrentCulture.DateTimeFormat.FirstDayOfWeek
        );

    private Tuple<DateTime, DateTime> DateRange;

    private List<PositionedAppointment> Events = [];

    protected override async Task OnParametersSetAsync()
    {
        DateRange = DateHelpers.GetDateRange(CalendarLayoutType, Date);
        Events = await LoadEvents();
    }

    private async void OnCalendarStateChange(CalendarLayoutType layoutType, DateTime date)
    {
        CalendarLayoutType = layoutType;
        Date = date;

        DateRange = DateHelpers.GetDateRange(layoutType, date);
        Events = await LoadEvents();

        StateHasChanged();
    }

    private async Task<List<PositionedAppointment>> LoadEvents()
        => await EventService.GetEvents(DateOnly.FromDateTime(DateRange.Item1), DateOnly.FromDateTime(DateRange.Item2));

    private async void TestErrors() =>
        await EventService.GetEventsWithError();
}
